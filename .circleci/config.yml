version: 2.1

setup: true

orbs:
  orb-tools: circleci/orb-tools@12.3
  shellcheck: circleci/shellcheck@3.2
  linear-release: mishchief/linear-release@volatile

# Use this tag to ensure test jobs always run
filters: &filters
  tags:
    only: /.*/

# Filter for release tags (semantic versions)
release-filters: &release-filters
  branches:
    ignore: /.*/
  tags:
    only: /^v[0-9]+\.[0-9]+\.[0-9]+$/

jobs:
  # PHASE 1: Test unreleased code changes before publishing
  test-unreleased-code:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout:
          fetch-depth: 0
      - run:
          name: Install Linear Release CLI
          command: bash src/scripts/install.sh
          environment:
            CLI_VERSION: latest
      - run:
          name: Test sync with unreleased code
          command: |
            export COMMAND=sync
            export INPUT_VERSION="test-${CIRCLE_SHA1:0:7}-${CIRCLE_BUILD_NUM}"
            export INPUT_NAME="Test Build ${CIRCLE_BRANCH} ${CIRCLE_SHA1:0:7}"
            bash src/scripts/run.sh

workflows:
  # Pre-publishing validation workflow
  lint-pack:
    jobs:
      # Lint YAML
      - orb-tools/lint:
          filters: *filters
      
      # Validate orb schema
      - orb-tools/pack:
          filters: *filters
      
      # Check best practices
      - orb-tools/review:
          filters: *filters
      
      # ShellCheck bash scripts
      - shellcheck/check:
          filters: *filters
          dir: ./src/scripts
          exclude: SC2148
      
      # PHASE 1: Test unreleased code changes (direct script execution)
      - test-unreleased-code:
          context: linear-release-test
          requires:
            - orb-tools/lint
            - orb-tools/pack
            - orb-tools/review
            - shellcheck/check
          filters: *filters
      
      # Publish development version for integration testing
      - orb-tools/publish:
          name: publish-dev
          orb_name: mishchief/linear-release
          vcs_type: github
          pub_type: dev
          requires:
            - test-unreleased-code
          context: orb-publishing
          filters: *filters
      
      # PHASE 2: Validate published dev orb
      - linear-release/deploy:
          name: sync-dev-release
          context: linear-release-dev
          access_key: $LINEAR_ACCESS_KEY
          version: "dev-${CIRCLE_SHA1:0:7}-${CIRCLE_BUILD_NUM}"
          release_name: "Dev Orb ${CIRCLE_SHA1:0:7}"
          cli_version: latest
          requires:
            - publish-dev
          filters: *filters
      
      # Trigger integration tests in test-deploy.yml
      - orb-tools/continue:
          orb_name: linear-release
          pipeline_number: << pipeline.number >>
          vcs_type: github
          context: orb-publishing
          requires:
            - publish-dev
          filters: *filters
